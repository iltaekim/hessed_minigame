<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²Œì„ ì„ íƒ</title>
  <style>
    :root { --card-gap: 28px; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif; margin: 0; background-color: #f9f9f9;
      padding: 18px; font-size: 17px; color:#222;
    }
    header {
      max-width: 1200px; margin: 0 auto 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 1.9em; }
    .pill {
      background:#fff; border:1px solid #ddd; border-radius: 999px; padding: 8px 12px; font-weight: 700;
    }
    #status { margin-left: auto; }
    .game-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
      gap: var(--card-gap);
      max-width: 1200px; margin: 12px auto 0;
    }
    @media (max-width: 980px) {
      .game-grid { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 640px) {
      body { padding: 12px; }
      .game-grid { grid-template-columns: 1fr; }
      :root { --card-gap: 18px; }
    }
    .game-card {
      background: #fff; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex; flex-direction: column;
    }
    .game-title {
      background: #333; color: white; padding: 14px 16px; font-size: 1.3em; font-weight: bold; display:flex; align-items:center; justify-content:space-between;
    }
    .badge { font-size: .85em; background: rgba(255,255,255,.15); padding: 4px 8px; border-radius: 999px; }
    .game-image {
      width: 100%; aspect-ratio: 3 / 2; background: linear-gradient(180deg, #efefef, #e5e5e5);
      display: flex; align-items: center; justify-content: center; position: relative; font-size: 1.2em; color:#666;
    }
    .overlay {
      display: none; position: absolute; inset: 0; background-color: rgba(0,0,0,0.5);
      color: white; justify-content: center; align-items: center; padding: 15px; text-align: center;
      font-size: 1.05em; line-height: 1.4; overflow-y:auto;
    }
    .game-image:hover .overlay { display: flex; }
    .slots {
      display: grid; grid-template-columns: repeat(6, 1fr);
      gap: 10px; padding: 14px; border-top:1px dashed #eee;
    }
    .slot {
      height: 44px; border-radius: 8px; background: #fff; border: 1px solid #ccc; cursor: pointer; position: relative;
      color: white; font-size: 16px; text-align: center; line-height: 44px; font-weight: 800; user-select:none;
      transition: transform .08s;
    }
    .slot:hover { transform: translateY(-1px); }
    .slot[data-locked="true"] { cursor: not-allowed; opacity: .7; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
    #summary {
      margin-top: 28px; padding: 16px; background: #fff; border: 1px solid #ccc; border-radius: 10px;
      max-width: 1200px; margin-left: auto; margin-right: auto; font-size: 1.02em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    #summary h2 { margin: 0 0 10px; font-size: 1.3em; }
    .sum-grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    @media (max-width: 900px){ .sum-grid{ grid-template-columns: 1fr; } }
    .sum-box { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .sum-title { font-weight:800; margin-bottom:8px; }
    .sum-line { padding:6px 0; border-bottom:1px dashed #eee; }
    .sum-line:last-child { border-bottom:0; }
    .toolbar { max-width: 1200px; margin: 8px auto 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap; color:#666; }
    .btn { padding: 10px 12px; border-radius: 8px; background:#fff; border:1px solid #ddd; cursor:pointer; font-weight:700; }
    .btn.danger { border-color:#e74c3c; color:#e74c3c; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1>ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”</h1>
    <div class="pill" id="team-pill">-</div>
    <div class="pill" id="status">ì„ íƒ: <span id="count">0</span> / <span id="max">-</span> (ë‚¨ì€ ì„ íƒ íšŸìˆ˜ìˆ˜: <span id="left">-</span>)</div>
  </header>

  <div class="toolbar">
    <button class="btn" id="back">ì¡° ë‹¤ì‹œ ì„ íƒ</button>
    <button class="btn danger" id="clearMine">ë‚´ ì„ íƒ ì „ì²´ í•´ì œ</button>
  </div>

  <div class="game-grid" id="grid"></div>

  <div id="summary">
    <h2>ì „ì²´ ì„ íƒ í˜„í™©</h2>
    <div class="sum-grid">
      <div class="sum-box">
        <div class="sum-title">ê²Œì„ë³„</div>
        <div id="summary-games"></div>
      </div>
      <div class="sum-box">
        <div class="sum-title">íŒ€ë³„ ì´í•©</div>
        <div id="summary-teams"></div>
      </div>
    </div>
  </div>

  <script>
    // íŒ€ ë¯¸ì„ íƒ ë°©ì§€
    const myTeam = localStorage.getItem('selectedTeam');
    if (!myTeam) { alert('ë¨¼ì € ì¡°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); location.href = 'index.html'; }

    // ê²Œì„ ì´ë¦„ / ì„¤ëª…
    const gameNames = {
      1:"ë¦´ë ˆì´ ì ìˆ˜ ëŒ€ê²°",
      2:"ë‹¨ì²´ ëˆˆì¹˜ ê²Œì„",
      3:"í’ì„  ì„œë°”ì´ë²Œ",
      4:"íˆë“  ì±Œë¦°ì§€",
      5:"ë°”ê°€ì§€ ì°¸ì°¸ì°¸",
      6:"ê³„ê³¡ ë¹„ì¹˜ë°œë¦¬ë³¼"
    };
    const gameDescriptions = {
      1: "ğŸ¤¿ ë¦´ë ˆì´ ì ìˆ˜ ëŒ€ê²°<br><br>íŒ€ì›ë“¤ì´ ì°¨ë¡€ëŒ€ë¡œ ì…ìˆ˜! ìˆ¨ì„ ì°¸ìœ¼ë©° ë²„í‹°ê³  ë‹¤ìŒ ì£¼ìì—ê²Œ ë°”í†µì„ ë„˜ê¸°ì„¸ìš”! ë§ˆì§€ë§‰ê¹Œì§€ ë¬¼ì†ì„ ì§€ë°°í•˜ëŠ” ì¡°ê°€ ê¶ê·¹ì˜ ì ìˆ˜ì™•ì— ë“±ê·¹í•©ë‹ˆë‹¤.",
      2: "ğŸ‘€ ë‹¨ì²´ ëˆˆì¹˜ ê²Œì„<br><br>ì—¬ëŸ¬ ì¡°ê°€ ë‹¨ì²´ë¡œ ëˆˆì¹˜ê²Œì„ì„ ì‹œì‘! ì‹¬ì¥ì´ ì¿µì¿µ~ ê¸´ì¥ë˜ëŠ” ìˆœê°„! íƒ€ì´ë°ì„ ì˜ëª» ì¡ìœ¼ë©´ ë°”ë¡œ íƒˆë½~ ìµœí›„ì˜ 3ì¸ì€ ê³¼ì—° ëˆ„êµ¬? ê·¸ ì‚¬ëŒë“¤ì´ ì†í•œ ì¡°ê°€ ìŠ¹ë¦¬ë¥¼ ê±°ë¨¸ì¥¡ë‹ˆë‹¤!",
      3: "ğŸˆ í’ì„  ì„œë°”ì´ë²Œ<br><br>ì†ì— ì†ì¡ê³  í’ì„  íŠ•ê¸°ê¸°! í’ì„ ì„ ë–¨ì–´ëœ¨ë¦¬ë©´ ì¦‰ì‹œ íƒˆë½~ ë¼ìš´ë“œê°€ ì§„í–‰ë ìˆ˜ë¡ í’ì„  ê°œìˆ˜ëŠ” ì ì  ì¦ê°€í•©ë‹ˆë‹¤. ê³¼ì—° ì–´ë–¤ ì¡°ê°€ ëê¹Œì§€ ì‚´ì•„ë‚¨ì„ì§€~?",
      4: "â“ íˆë“  ì±Œë¦°ì§€<br><br>ë¹„ë°€ì— ì‹¸ì¸ ë¯¸ìŠ¤í„°ë¦¬ ê²Œì„! ë¹„ë°€ì˜ ê²Œì„ì´ ì§„í–‰ë©ë‹ˆë‹¤! ê³¼ì—° ì–´ë–¤ ê²Œì„ì´ í¼ì³ì§ˆê¹Œìš”? ì •ë§ ì¬ë°Œì„ì§€ë„?",
      5: "ğŸ¥¶ ë°”ê°€ì§€ ì°¸ì°¸ì°¸<br><br>ì°¸ì°¸ì°¸ì—ì„œ ì´ê¸°ë©´ ë°”ê°€ì§€ ë¬¼ì‹¸ë‹¤êµ¬! ì§€ë©´ ë°©ì–´ ê°€ëŠ¥~ ìƒëŒ€ë°© ì–¼êµ´ì˜ í¬ìŠ¤íŠ¸ì‡ì„ ë–¨ì–´ëœ¨ë¦¬ë©´ ì§œë¦¿í•œ ìŠ¹ë¦¬! ì›ƒìŒê³¼ ë¬¼ë²¼ë½ì´ ë™ì‹œì— í„°ì§‘ë‹ˆë‹¤.",
      6: "ğŸ ê³„ê³¡ ë¹„ì¹˜ë°œë¦¬ë³¼<br><br>ë¬¼ë†€ì´ì—ì„œ ë¹ ì§ˆ ìˆ˜ ì—†ëŠ” ë¹„ì¹˜ë°œë¦¬ë³¼~ ì´ë²ˆì—” ê³„ê³¡ì—ì„œ ì¦ê²¨ë³¼ê¹Œìš”?!"
    };

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCdCPcboDLiOHz_-JZdEockQqxy3-ROMK8",
      authDomain: "hessed-minigame.firebaseapp.com",
      databaseURL: "https://hessed-minigame-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hessed-minigame",
      storageBucket: "hessed-minigame.appspot.com",
      messagingSenderId: "1080476713749",
      appId: "1:1080476713749:web:4dd2f4482aec89a5931f1c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // íŒ€ ìƒ‰ìƒ
    const teamColors = { 1:'#e74c3c', 2:'#e67e22', 3:'#f1c40f', 4:'#2ecc71', 5:'#3498db', 6:'#34495e', 7:'#9b59b6', 8:'#fd79a8', 9:'#7f8c8d' };
    const teamColor = teamColors[myTeam] || '#000';

    // ìƒíƒœ
    let maxSelections = 4;
    let slotConfig = { 1:4, 2:5, 3:5, 4:4, 5:4, 6:4 };
    let selections = {};
    let selectionCount = 0;

    // UI
    const grid = document.getElementById('grid');
    const statusCount = document.getElementById('count');
    const statusMax = document.getElementById('max');
    const statusLeft = document.getElementById('left');
    const teamPill = document.getElementById('team-pill');
    const sumGames = document.getElementById('summary-games');
    const sumTeams = document.getElementById('summary-teams');

    document.getElementById('back').onclick = () => location.href='index.html';
    document.getElementById('clearMine').onclick = async () => {
      const updates = {};
      for (const g in selections) {
        selections[g].forEach((s, idx) => {
          if (s && String(s.team) === String(myTeam)) updates[`selections/${g}/${idx}`] = null;
        });
      }
      await db.ref().update(updates);
    };

    teamPill.innerHTML = `<span class="dot" style="background:${teamColor}"></span>${myTeam}ì¡°`;

    const updateStatus = () => {
      statusCount.textContent = selectionCount;
      statusMax.textContent = maxSelections;
      statusLeft.textContent = Math.max(0, maxSelections - selectionCount);
    };

    // ìš”ì•½(ê²Œì„ë³„/íŒ€ë³„)
    const renderSummary = () => {
      // ê²Œì„ë³„
      sumGames.innerHTML = '';
      const gameIds = Object.keys(slotConfig).map(Number).sort((a,b)=>a-b);
      gameIds.forEach(gid => {
        const arr = selections[gid] || [];
        const pickedTeams = arr.map(s => s?.team).filter(Boolean).map(String);
        const uniqueTeams = [...new Set(pickedTeams)];
        const line = document.createElement('div');
        line.className = 'sum-line';
        const name = gameNames[gid] || `ê²Œì„ ${gid}`;
        line.textContent = uniqueTeams.length
          ? `${name}: ${uniqueTeams.map(t => `${t}ì¡°`).join(', ')}`
          : `${name}: ì„ íƒ ì—†ìŒ`;
        sumGames.appendChild(line);
      });

      // íŒ€ë³„ ì´í•©
      const totals = {};
      gameIds.forEach(gid => {
        (selections[gid] || []).forEach(s => {
          if (s && s.team) totals[s.team] = (totals[s.team] || 0) + 1;
        });
      });
      sumTeams.innerHTML = '';
      const tKeys = Object.keys(totals).sort((a,b)=>Number(a)-Number(b));
      if (!tKeys.length) {
        const line = document.createElement('div');
        line.className = 'sum-line';
        line.textContent = 'ì•„ì§ ì„ íƒì´ ì—†ìŠµë‹ˆë‹¤.';
        sumTeams.appendChild(line);
      } else {
        tKeys.forEach(t => {
          const line = document.createElement('div');
          line.className = 'sum-line';
          line.innerHTML = `<span class="dot" style="background:${teamColors[t]}"></span>${t}ì¡°: ${totals[t]}ê°œ`;
          sumTeams.appendChild(line);
        });
      }
    };

    // ìŠ¬ë¡¯ í´ë¦­ í•¸ë“¤ëŸ¬
    const attachSlotHandlers = (slotEl, gameId, slotIdx) => {
      slotEl.onclick = async () => {
        const current = selections[gameId]?.[slotIdx] ?? null;

        if (current && String(current.team) === String(myTeam)) {
          await db.ref(`selections/${gameId}/${slotIdx}`).set(null);
          return;
        }
        if (current) { alert('ì´ë¯¸ ì„ íƒëœ ìŠ¬ë¡¯ì…ë‹ˆë‹¤.'); return; }

        const hasMineInGame = (selections[gameId] || []).some(s => s && String(s.team) === String(myTeam));
        if (hasMineInGame) { alert('ê°™ì€ ê²Œì„ì—ì„œ ì¤‘ë³µ ì„ íƒì€ ë¶ˆê°€í•©ë‹ˆë‹¤.'); return; }

        if (selectionCount >= maxSelections) { alert('ìµœëŒ€ ì„ íƒ ê°€ëŠ¥ ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.'); return; }

        const ref = db.ref(`selections/${gameId}/${slotIdx}`);
        await ref.transaction(currentData => {
          if (currentData === null) return { team: myTeam, color: teamColor };
          return;
        }, (err, committed) => {
          if (err) alert('ì„ íƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          else if (!committed) alert('ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë°©ê¸ˆ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
      };
    };

    // ì¹´ë“œ ë¹Œë“œ
    const buildCard = (gameId) => {
      const card = document.createElement('div');
      card.className = 'game-card';
      const used = (selections[gameId] || []).filter(Boolean).length;
      const total = slotConfig[gameId];

      card.innerHTML = `
        <div class="game-title">
          <span>${gameNames[gameId] || `ê²Œì„ ${gameId}`}</span>
          <span class="badge">ì°¸ê°€íŒ€ ${used}/${total}</span>
        </div>
        <div class="game-image">
          <img src="images/game-${gameId}.png" alt="${gameNames[gameId]}" style="width:100%; height:100%; object-fit:cover;">
          <div class="overlay">${gameDescriptions[gameId] || ''}</div>
        </div>
        <div class="slots" style="grid-template-columns: repeat(${Math.min(total, 6)}, 1fr)"></div>
      `;

      const slotsWrap = card.querySelector('.slots');
      for (let idx = 0; idx < total; idx++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const entry = selections[gameId]?.[idx] || null;
        if (entry) {
          slot.style.backgroundColor = entry.color;
          slot.textContent = entry.team;
        }
        attachSlotHandlers(slot, gameId, idx);
        slotsWrap.appendChild(slot);
      }
      return card;
    };

    // ì „ì²´ ë Œë”
    const renderAll = () => {
      grid.innerHTML = '';
      const gameIds = Object.keys(slotConfig).map(Number).sort((a,b)=>a-b);
      gameIds.forEach(id => {
        if (!selections[id]) selections[id] = Array(slotConfig[id]).fill(null);
        grid.appendChild(buildCard(id));
      });
      // ë‚´ ì„ íƒ ìˆ˜ ì¬ê³„ì‚°
      selectionCount = 0;
      for (const g in selections) {
        (selections[g] || []).forEach(s => { if (s && String(s.team) === String(myTeam)) selectionCount++; });
      }
      updateStatus();
      renderSummary();  // â† ìš”ì•½ ê°±ì‹ 
    };

    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
    db.ref('config').on('value', snap => {
      const cfg = snap.val() || {};
      if (typeof cfg.maxSelections === 'number') maxSelections = cfg.maxSelections;
      if (cfg.slotConfig && typeof cfg.slotConfig === 'object') slotConfig = cfg.slotConfig;
      renderAll();
    });

    db.ref('selections').on('value', snapshot => {
      const data = snapshot.val() || {};
      const next = {};
      for (const gId of Object.keys(slotConfig)) {
        const total = slotConfig[gId];
        next[gId] = Array.from({ length: total }, (_, idx) => data[gId]?.[idx] ?? null);
      }
      selections = next;
      renderAll();
    });

    // ì´ˆê¸° í‘œì‹œ
    teamPill.innerHTML = `<span class="dot" style="background:${teamColor}"></span>${myTeam}ì¡°`;
    updateStatus();
  </script>
</body>
</html>

