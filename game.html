<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>게임 선택</title>
  <style>
    :root { --card-gap: 28px; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif; margin: 0; background-color: #f9f9f9;
      padding: 18px; font-size: 17px; color:#222;
    }
    header {
      max-width: 1200px; margin: 0 auto 12px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 1.9em; }
    .pill {
      background:#fff; border:1px solid #ddd; border-radius: 999px; padding: 8px 12px; font-weight: 700;
    }
    #status { margin-left: auto; }
    .game-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
      gap: var(--card-gap);
      max-width: 1200px; margin: 12px auto 0;
    }
    @media (max-width: 980px) {
      .game-grid { grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 640px) {
      body { padding: 12px; }
      .game-grid { grid-template-columns: 1fr; }
      :root { --card-gap: 18px; }
    }
    .game-card {
      background: #fff; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex; flex-direction: column;
    }
    .game-title {
      background: #333; color: white; padding: 14px 16px; font-size: 1.3em; font-weight: bold; display:flex; align-items:center; justify-content:space-between;
    }
    .badge { font-size: .85em; background: rgba(255,255,255,.15); padding: 4px 8px; border-radius: 999px; }
    .game-image {
      width: 100%; aspect-ratio: 3 / 2; background: linear-gradient(180deg, #efefef, #e5e5e5);
      display: flex; align-items: center; justify-content: center; position: relative; font-size: 1.2em; color:#666;
    }
    .overlay {
      display: none; position: absolute; inset: 0; background-color: rgba(0,0,0,0.5);
      color: white; justify-content: center; align-items: center; padding: 15px; text-align: center;
      font-size: 1.05em; line-height: 1.4; overflow-y:auto;
    }
    .game-image:hover .overlay { display: flex; }
    .slots {
      display: grid; grid-template-columns: repeat(6, 1fr);
      gap: 10px; padding: 14px; border-top:1px dashed #eee;
    }
    .slot {
      height: 44px; border-radius: 8px; background: #fff; border: 1px solid #ccc; cursor: pointer; position: relative;
      color: white; font-size: 16px; text-align: center; line-height: 44px; font-weight: 800; user-select:none;
      transition: transform .08s;
    }
    .slot:hover { transform: translateY(-1px); }
    .slot[data-locked="true"] { cursor: not-allowed; opacity: .7; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
    #summary {
      margin-top: 28px; padding: 16px; background: #fff; border: 1px solid #ccc; border-radius: 10px;
      max-width: 1200px; margin-left: auto; margin-right: auto; font-size: 1.02em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    #summary h2 { margin: 0 0 10px; font-size: 1.3em; }
    .sum-grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    @media (max-width: 900px){ .sum-grid{ grid-template-columns: 1fr; } }
    .sum-box { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
    .sum-title { font-weight:800; margin-bottom:8px; }
    .sum-line { padding:6px 0; border-bottom:1px dashed #eee; }
    .sum-line:last-child { border-bottom:0; }
    .toolbar { max-width: 1200px; margin: 8px auto 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap; color:#666; }
    .btn { padding: 10px 12px; border-radius: 8px; background:#fff; border:1px solid #ddd; cursor:pointer; font-weight:700; }
    .btn.danger { border-color:#e74c3c; color:#e74c3c; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <h1>게임을 선택하세요</h1>
    <div class="pill" id="team-pill">-</div>
    <div class="pill" id="status">선택: <span id="count">0</span> / <span id="max">-</span> (남은 선택 횟수수: <span id="left">-</span>)</div>
  </header>

  <div class="toolbar">
    <button class="btn" id="back">조 다시 선택</button>
    <button class="btn danger" id="clearMine">내 선택 전체 해제</button>
  </div>

  <div class="game-grid" id="grid"></div>

  <div id="summary">
    <h2>전체 선택 현황</h2>
    <div class="sum-grid">
      <div class="sum-box">
        <div class="sum-title">게임별</div>
        <div id="summary-games"></div>
      </div>
      <div class="sum-box">
        <div class="sum-title">팀별 총합</div>
        <div id="summary-teams"></div>
      </div>
    </div>
  </div>

  <script>
    // 팀 미선택 방지
    const myTeam = localStorage.getItem('selectedTeam');
    if (!myTeam) { alert('먼저 조를 선택해주세요.'); location.href = 'index.html'; }

    // 게임 이름 / 설명
    const gameNames = {
      1:"릴레이 잠수 대결",
      2:"단체 눈치 게임",
      3:"풍선 서바이벌",
      4:"히든 챌린지",
      5:"바가지 참참참",
      6:"계곡 비치발리볼"
    };
    const gameDescriptions = {
      1: "🤿 릴레이 잠수 대결<br><br>팀원들이 차례대로 입수! 숨을 참으며 버티고 다음 주자에게 바통을 넘기세요! 마지막까지 물속을 지배하는 조가 궁극의 잠수왕에 등극합니다.",
      2: "👀 단체 눈치 게임<br><br>여러 조가 단체로 눈치게임을 시작! 심장이 쿵쿵~ 긴장되는 순간! 타이밍을 잘못 잡으면 바로 탈락~ 최후의 3인은 과연 누구? 그 사람들이 속한 조가 승리를 거머쥡니다!",
      3: "🎈 풍선 서바이벌<br><br>손에 손잡고 풍선 튕기기! 풍선을 떨어뜨리면 즉시 탈락~ 라운드가 진행될수록 풍선 개수는 점점 증가합니다. 과연 어떤 조가 끝까지 살아남을지~?",
      4: "❓ 히든 챌린지<br><br>비밀에 싸인 미스터리 게임! 비밀의 게임이 진행됩니다! 과연 어떤 게임이 펼쳐질까요? 정말 재밌을지도?",
      5: "🥶 바가지 참참참<br><br>참참참에서 이기면 바가지 물싸다구! 지면 방어 가능~ 상대방 얼굴의 포스트잇을 떨어뜨리면 짜릿한 승리! 웃음과 물벼락이 동시에 터집니다.",
      6: "🏐 계곡 비치발리볼<br><br>물놀이에서 빠질 수 없는 비치발리볼~ 이번엔 계곡에서 즐겨볼까요?!"
    };

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCdCPcboDLiOHz_-JZdEockQqxy3-ROMK8",
      authDomain: "hessed-minigame.firebaseapp.com",
      databaseURL: "https://hessed-minigame-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hessed-minigame",
      storageBucket: "hessed-minigame.appspot.com",
      messagingSenderId: "1080476713749",
      appId: "1:1080476713749:web:4dd2f4482aec89a5931f1c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 팀 색상
    const teamColors = { 1:'#e74c3c', 2:'#e67e22', 3:'#f1c40f', 4:'#2ecc71', 5:'#3498db', 6:'#34495e', 7:'#9b59b6', 8:'#fd79a8', 9:'#7f8c8d' };
    const teamColor = teamColors[myTeam] || '#000';

    // 상태
    let maxSelections = 4;
    let slotConfig = { 1:4, 2:5, 3:5, 4:4, 5:4, 6:4 };
    let selections = {};
    let selectionCount = 0;

    // UI
    const grid = document.getElementById('grid');
    const statusCount = document.getElementById('count');
    const statusMax = document.getElementById('max');
    const statusLeft = document.getElementById('left');
    const teamPill = document.getElementById('team-pill');
    const sumGames = document.getElementById('summary-games');
    const sumTeams = document.getElementById('summary-teams');

    document.getElementById('back').onclick = () => location.href='index.html';
    document.getElementById('clearMine').onclick = async () => {
      const updates = {};
      for (const g in selections) {
        selections[g].forEach((s, idx) => {
          if (s && String(s.team) === String(myTeam)) updates[`selections/${g}/${idx}`] = null;
        });
      }
      await db.ref().update(updates);
    };

    teamPill.innerHTML = `<span class="dot" style="background:${teamColor}"></span>${myTeam}조`;

    const updateStatus = () => {
      statusCount.textContent = selectionCount;
      statusMax.textContent = maxSelections;
      statusLeft.textContent = Math.max(0, maxSelections - selectionCount);
    };

    // 요약(게임별/팀별)
    const renderSummary = () => {
      // 게임별
      sumGames.innerHTML = '';
      const gameIds = Object.keys(slotConfig).map(Number).sort((a,b)=>a-b);
      gameIds.forEach(gid => {
        const arr = selections[gid] || [];
        const pickedTeams = arr.map(s => s?.team).filter(Boolean).map(String);
        const uniqueTeams = [...new Set(pickedTeams)];
        const line = document.createElement('div');
        line.className = 'sum-line';
        const name = gameNames[gid] || `게임 ${gid}`;
        line.textContent = uniqueTeams.length
          ? `${name}: ${uniqueTeams.map(t => `${t}조`).join(', ')}`
          : `${name}: 선택 없음`;
        sumGames.appendChild(line);
      });

      // 팀별 총합
      const totals = {};
      gameIds.forEach(gid => {
        (selections[gid] || []).forEach(s => {
          if (s && s.team) totals[s.team] = (totals[s.team] || 0) + 1;
        });
      });
      sumTeams.innerHTML = '';
      const tKeys = Object.keys(totals).sort((a,b)=>Number(a)-Number(b));
      if (!tKeys.length) {
        const line = document.createElement('div');
        line.className = 'sum-line';
        line.textContent = '아직 선택이 없습니다.';
        sumTeams.appendChild(line);
      } else {
        tKeys.forEach(t => {
          const line = document.createElement('div');
          line.className = 'sum-line';
          line.innerHTML = `<span class="dot" style="background:${teamColors[t]}"></span>${t}조: ${totals[t]}개`;
          sumTeams.appendChild(line);
        });
      }
    };

    // 슬롯 클릭 핸들러
    const attachSlotHandlers = (slotEl, gameId, slotIdx) => {
      slotEl.onclick = async () => {
        const current = selections[gameId]?.[slotIdx] ?? null;

        if (current && String(current.team) === String(myTeam)) {
          await db.ref(`selections/${gameId}/${slotIdx}`).set(null);
          return;
        }
        if (current) { alert('이미 선택된 슬롯입니다.'); return; }

        const hasMineInGame = (selections[gameId] || []).some(s => s && String(s.team) === String(myTeam));
        if (hasMineInGame) { alert('같은 게임에서 중복 선택은 불가합니다.'); return; }

        if (selectionCount >= maxSelections) { alert('최대 선택 가능 수를 초과했습니다.'); return; }

        const ref = db.ref(`selections/${gameId}/${slotIdx}`);
        await ref.transaction(currentData => {
          if (currentData === null) return { team: myTeam, color: teamColor };
          return;
        }, (err, committed) => {
          if (err) alert('선택 처리 중 오류가 발생했습니다.');
          else if (!committed) alert('다른 사용자가 방금 선택했습니다. 다시 시도해주세요.');
        });
      };
    };

    // 카드 빌드
    const buildCard = (gameId) => {
      const card = document.createElement('div');
      card.className = 'game-card';
      const used = (selections[gameId] || []).filter(Boolean).length;
      const total = slotConfig[gameId];

      card.innerHTML = `
        <div class="game-title">
          <span>${gameNames[gameId] || `게임 ${gameId}`}</span>
          <span class="badge">참가팀 ${used}/${total}</span>
        </div>
        <div class="game-image">
          <img src="images/game-${gameId}.png" alt="${gameNames[gameId]}" style="width:100%; height:100%; object-fit:cover;">
          <div class="overlay">${gameDescriptions[gameId] || ''}</div>
        </div>
        <div class="slots" style="grid-template-columns: repeat(${Math.min(total, 6)}, 1fr)"></div>
      `;

      const slotsWrap = card.querySelector('.slots');
      for (let idx = 0; idx < total; idx++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const entry = selections[gameId]?.[idx] || null;
        if (entry) {
          slot.style.backgroundColor = entry.color;
          slot.textContent = entry.team;
        }
        attachSlotHandlers(slot, gameId, idx);
        slotsWrap.appendChild(slot);
      }
      return card;
    };

    // 전체 렌더
    const renderAll = () => {
      grid.innerHTML = '';
      const gameIds = Object.keys(slotConfig).map(Number).sort((a,b)=>a-b);
      gameIds.forEach(id => {
        if (!selections[id]) selections[id] = Array(slotConfig[id]).fill(null);
        grid.appendChild(buildCard(id));
      });
      // 내 선택 수 재계산
      selectionCount = 0;
      for (const g in selections) {
        (selections[g] || []).forEach(s => { if (s && String(s.team) === String(myTeam)) selectionCount++; });
      }
      updateStatus();
      renderSummary();  // ← 요약 갱신
    };

    // 실시간 리스너
    db.ref('config').on('value', snap => {
      const cfg = snap.val() || {};
      if (typeof cfg.maxSelections === 'number') maxSelections = cfg.maxSelections;
      if (cfg.slotConfig && typeof cfg.slotConfig === 'object') slotConfig = cfg.slotConfig;
      renderAll();
    });

    db.ref('selections').on('value', snapshot => {
      const data = snapshot.val() || {};
      const next = {};
      for (const gId of Object.keys(slotConfig)) {
        const total = slotConfig[gId];
        next[gId] = Array.from({ length: total }, (_, idx) => data[gId]?.[idx] ?? null);
      }
      selections = next;
      renderAll();
    });

    // 초기 표시
    teamPill.innerHTML = `<span class="dot" style="background:${teamColor}"></span>${myTeam}조`;
    updateStatus();
  </script>
</body>
</html>

