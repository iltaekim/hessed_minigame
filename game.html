<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>게임 선택</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
      font-size: 24px;
    }
    .game-box {
      display: inline-block;
      margin: 20px;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
    }
    .slot {
      width: 60px;
      height: 60px;
      margin: 10px auto;
      border-radius: 8px;
      background-color: white;
      border: 2px solid #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .slot.filled {
      color: white;
    }
    .warning {
      color: red;
      font-size: 18px;
      margin-top: 10px;
    }
  </style>
  <!-- ✅ Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>게임을 선택하세요</h1>
  <div id="games-container"></div>
  <div id="warning" class="warning"></div>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCdCPcboDLiOHz_-JZdEockQqxy3-ROMK8",
      authDomain: "hessed-minigame.firebaseapp.com",
      databaseURL: "https://hessed-minigame-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hessed-minigame",
      storageBucket: "hessed-minigame.firebasestorage.app",
      messagingSenderId: "1080476713749",
      appId: "1:1080476713749:web:4dd2f4482aec89a5931f1c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const selectedTeam = localStorage.getItem('selectedTeam');
    const selectedColor = localStorage.getItem('selectedColor');

    if (!selectedTeam || !selectedColor) {
      alert('팀 정보가 없습니다. 처음 화면으로 돌아갑니다.');
      window.location.href = 'index.html';
    }

    const MAX_SELECTION_PER_TEAM = 4;
    const TOTAL_GAMES = 6;
    const SLOTS_PER_GAME = 3;

    const selections = {}; // gameId -> list of team numbers
    const teamSelectionCount = {}; // team number -> count

    for (let i = 1; i <= TOTAL_GAMES; i++) {
      selections[i] = [];
    }

    const container = document.getElementById('games-container');

    for (let gameId = 1; gameId <= TOTAL_GAMES; gameId++) {
      const gameBox = document.createElement('div');
      gameBox.className = 'game-box';
      gameBox.innerHTML = `<h2>게임 ${gameId}</h2>`;

      for (let slotIndex = 0; slotIndex < SLOTS_PER_GAME; slotIndex++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.gameId = gameId;
        slot.dataset.index = slotIndex;

        slot.addEventListener('click', () => handleSlotClick(slot));

        gameBox.appendChild(slot);
      }

      container.appendChild(gameBox);
    }

    // 초기 데이터 로딩
    for (let gameId = 1; gameId <= TOTAL_GAMES; gameId++) {
      for (let slotIndex = 0; slotIndex < SLOTS_PER_GAME; slotIndex++) {
        db.ref(`selections/game${gameId}/slot${slotIndex}`).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            if (data) {
              const slot = document.querySelector(`.slot[data-game-id="${gameId}"][data-index="${slotIndex}"]`);
              if (slot) {
                slot.classList.add('filled');
                slot.style.backgroundColor = data.color;
                slot.innerText = `${data.team}조`;
                slot.dataset.team = data.team;

                selections[gameId].push(data.team);
                teamSelectionCount[data.team] = (teamSelectionCount[data.team] || 0) + 1;
              }
            }
          });
      }
    }

    function handleSlotClick(slot) {
      const gameId = parseInt(slot.dataset.gameId);
      const slotIndex = slot.dataset.index;
      const currentTeam = parseInt(selectedTeam);

      const teamAlreadyInGame = selections[gameId].includes(currentTeam);
      const isFilled = slot.classList.contains('filled');

      // 클릭 취소
      if (isFilled && slot.dataset.team == selectedTeam) {
        slot.classList.remove('filled');
        slot.style.backgroundColor = 'white';
        slot.innerText = '';
        slot.dataset.team = '';

        selections[gameId] = selections[gameId].filter(t => t != currentTeam);
        teamSelectionCount[currentTeam] = (teamSelectionCount[currentTeam] || 1) - 1;

        db.ref(`selections/game${gameId}/slot${slotIndex}`).remove();
        return;
      }

      if (teamAlreadyInGame) {
        showWarning('이미 이 게임을 선택했습니다.');
        return;
      }

      if ((teamSelectionCount[currentTeam] || 0) >= MAX_SELECTION_PER_TEAM) {
        showWarning('최대 선택 가능 수를 초과했습니다.');
        return;
      }

      if (isFilled) return;

      slot.classList.add('filled');
      slot.style.backgroundColor = selectedColor;
      slot.innerText = `${currentTeam}조`;
      slot.dataset.team = currentTeam;

      selections[gameId].push(currentTeam);
      teamSelectionCount[currentTeam] = (teamSelectionCount[currentTeam] || 0) + 1;
      clearWarning();

      db.ref(`selections/game${gameId}/slot${slotIndex}`).set({
        team: currentTeam,
        color: selectedColor
      });
    }

    function showWarning(msg) {
      document.getElementById('warning').innerText = msg;
    }

    function clearWarning() {
      document.getElementById('warning').innerText = '';
    }
  </script>
</body>
</html>
